# SQL脚本重构 TODO 列表

## 已完成的修复和重构

-   修正 `01_create_tables.sql` 中 `ProductImage` 的语法错误及 `Order` 和 `ReturnRequest` 的外键 `ON DELETE CASCADE`。
-   确保触发器文件 (`01_product_triggers.sql`, `02_order_triggers.sql`, `03_evaluation_triggers.sql`) 包含正确的触发器定义。
-   移除了 `01_user_procedures.sql` 中重复的管理员存储过程定义。
-   修正 `sp_RequestMagicLink` 在创建新用户时生成非空密码哈希。
-   修正 `sp_ReviewProduct` 移除了拒绝商品时将库存设为 0 的逻辑。
-   修正 `sp_UpdateImageSortOrder` 和 `sp_DeleteImage` 添加了权限检查和主图维护逻辑。
-   修正 `sp_GetChatMessagesByProduct` 添加了聊天参与者权限检查，并应用了逻辑删除过滤。
-   更新了 `drop_all.sql` 文件以包含所有当前自定义数据库对象的删除语句。
-   **已实现:** `sp_SetChatMessageVisibility` 存储过程 (ChatMessage 逻辑删除)。
-   **已实现:** `sp_DeleteUser` 存储过程。

## 待解决或需要进一步检查的问题

-   **检查并移除 `Order` 和 `ReturnRequest` 表外键的 `ON DELETE CASCADE`:** (**已检查，发现外键并非 CASCADE 而是 NO ACTION，此项TODO描述不准确，但保留检查关联记录处理的必要性。**)
-   **`tr_Order_AfterCancel_RestoreQuantity` 的库存恢复逻辑:** 确认基于订单数量 `i.Quantity` 恢复库存对于所有订单取消场景（包括卖家拒绝）是否完全正确。目前的理解是适用于订单完成前的取消。
-   **退货（管理员介入）的钱款和退货协调:** 数据库层面的状态更新和库存恢复已基本实现 (`sp_AdminProcessReturnIntervention`)，但实际的钱款退还和物理商品退回流程需要在应用层与支付/物流服务集成。
-   **商品模块筛选优化:** 当前 `sp_GetProductList` 基本功能完善，可以考虑根据需求增加全文搜索支持或更灵活的组合筛选。
-   **`ChatMessage` 的逻辑删除存储过程:** 需要实现相应的存储过程（例如 `sp_SetChatMessageVisibility`）用于更新 `SenderVisible` 和 `ReceiverVisible` 字段，而不是物理删除消息记录。（**已实现，此TODO描述不准确**）
-   **`sp_CreateProduct` 的 `@imageUrls` 参数:** 当前使用逗号分隔字符串传递图片 URL 列表的方式存在潜在风险（URL中含逗号），且不如表值参数高效和健壮。**强烈建议**修改应用层调用方式，使用表值参数传递图片 URL 列表。（**计划在商品模块开发中处理**）
-   **`sp_RequestReturn` 是否需要更新订单状态:** 在买家发起退货请求 (`sp_RequestReturn`) 后，订单表 ([Order]) 的 Status 字段是否需要更新为一个新状态（例如 'ReturnRequested' 或 'UnderReturnProcess'）来反映订单正在走退货流程？这取决于业务流程设计。**决定：暂时不修改 Order 表状态，依赖 ReturnRequest 状态判断。sp_RequestReturn 中保留 TODO 注释。**
-   **触发器中的 UPDATE 操作和潜在风险:** 触发器，特别是 `tr_Product_AfterUpdate_QuantityStatus` 中包含基于其他表数据或自身表更新结果进行再次更新的逻辑。这种设计可能存在死锁或无限循环触发的风险，尤其在并发操作较高或逻辑复杂时。建议对涉及 UPDATE 操作的触发器进行详细的审阅和全面的压力测试，确保其健壮性和性能。
-   **对被举报用户的处理:** 对被举报用户的禁用或信用分调整需要在应用层调用相应的管理员存储过程实现。（**已实现DAL和Service层方法，需要API和测试**）
-   **其他潜在的逻辑或边界问题:** 需要对所有存储过程和触发器进行更详细的代码审阅，寻找可能的边界条件处理不当、性能瓶颈等问题。
-   **事务完整性检查:** 确保所有涉及多个步骤的存储过程都使用了事务，并在出错时正确回滚。
-   **错误处理和日志记录:** 检查所有存储过程的错误处理是否健壮，是否需要添加错误日志记录机制。
-   **存储过程的 SQL 语句复杂度:** 检查是否所有存储过程都满足至少包含一条涉及 3 个表的 JOIN 语句或包含控制流 (IF/CASE/WHILE) 语句的要求。已进行的修正应该覆盖了大部分，但需要再次确认。
-   **命名规范:** 再次确认所有新建或修改的对象是否遵循 PascalCase 命名规范。
-   **面向 UI 的查询存储过程:** 再次确认面向 UI 的查询存储过程只返回一个结果集，没有不必要的额外 SELECT 语句。
-   **数据库初始化脚本的用户创建逻辑:** 检查 `db_init.py` 中创建用户时出现的 UNIQUE KEY 约束错误，确保用户创建逻辑正确处理唯一性约束。
-   **数据库备份和恢复:** 需要编写数据库备份和恢复的说明文档，包括定期备份策略和恢复流程。

## 需要应用层处理的事项

-   **实际文件上传/删除:** 商品图片的实际文件上传和删除需要由应用层负责调用对象存储服务（如阿里云 OSS, AWS S3 等）的 API。
-   **图片 URL 列表传递:** 修改应用层调用 `sp_CreateProduct` 的方式，使用表值参数传递图片 URL 列表，而不是逗号分隔的字符串。（**计划在商品模块开发中处理**）
-   **退货流程的钱款处理:** 在管理员判定退货同意后，应用层需要调用支付接口执行退款操作。
-   **退货流程的商品退回协调:** 应用层需要引导买家退回商品，并可能记录物流信息。
-   **系统通知发送:** 应用层需要根据数据库中插入的系统通知记录，通过邮件、站内信、消息队列等方式实际发送通知给用户。（**已实现DAL层方法，Service层方法需要补充**）
-   **对被举报用户的操作:** 在管理员处理举报时，应用层需要调用 `sp_ChangeUserStatus` 或 `sp_AdjustUserCredit` 等存储过程对被举报用户执行操作。（**已实现DAL和Service层方法，需要API和测试**）
-   **信用分调整日志记录:** 如果需要详细的信用分调整日志，可以在应用层记录或调用专门的日志存储过程。
-   **魔术链接的发送:** 应用层需要根据 `sp_RequestMagicLink` 返回的令牌和用户ID，生成包含魔术链接的邮件并发送给用户。
-   **魔术链接的验证和登录:** 应用层需要在用户点击魔术链接后，调用 `sp_VerifyMagicLink` 验证令牌，并完成用户登录流程。
-   **聊天消息的逻辑删除接口:** 应用层需要提供接口供用户执行消息的逻辑删除操作，该接口将调用相应的存储过程更新 `SenderVisible` 或 `ReceiverVisible` 字段。（**已实现DAL层和Service层方法，需要API和测试**）
-   **后台任务/定时任务:** 例如清理过期的魔术链接令牌、定期检查订单状态等，可能需要后台任务支持。
-   **数据校验:** 应用层在调用存储过程前应进行初步的数据校验，减轻数据库的负担。
-   **用户界面实现:** 实现与上述存储过程交互的各种用户界面，包括商品列表/详情、订单管理、聊天界面、个人中心、管理员后台等。
-   **数据库连接池配置:** 在应用层配置合适的数据库连接池大小和超时设置，以优化性能和资源利用。
-   **数据库性能监控:** 实现数据库性能监控和日志记录机制，包括慢查询日志、连接池状态监控等。

## 后续计划

1.  继续对所有脚本进行详细的代码审阅。
2.  检查并修正 `01_create_tables.sql` 中关于订单和退货请求的外键定义。（**已检查，发现描述不准确，已在TODO中更新**）
3.  实现 ChatMessage 的逻辑删除存储过程。（**已完成存储过程和 DAL/Service 方法，需要 API 和测试**）
4.  根据审阅结果，进一步修正和优化现有存储过程。
5.  更新 TODO 文档，详细记录每个问题的具体解决方案或需要采取的步骤。
6.  提供完整的脚本文件供部署和测试。 