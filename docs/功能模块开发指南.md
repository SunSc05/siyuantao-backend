ã€æ€æºæ·˜ã€‘æ–°åŠŸèƒ½æ¨¡å—å¼€å‘æŒ‡å—

1. ç®€ä»‹

ç›®æ ‡ï¼šä¸ºã€æ€æºæ·˜ã€‘é¡¹ç›®æä¾›ä¸€å¥—æ ‡å‡†åŒ–çš„æ–°åŠŸèƒ½æ¨¡å—ï¼ˆå¦‚å•†å“ã€è®¢å•ã€è¯„ä»·ç­‰ï¼‰å¼€å‘æµç¨‹ã€‚
æ ¸å¿ƒåŸåˆ™ï¼šæ‰€æœ‰æ–°æ¨¡å—éƒ½å¿…é¡»éµå¾ªå·²å»ºç«‹çš„åˆ†å±‚æ¶æ„ï¼Œå¹¶æ‹¥æœ‰å…¨é¢çš„è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–ã€‚
é»„é‡‘æ ‡å‡†ï¼šç”¨æˆ·æ¨¡å— (app/user) æ˜¯æˆ‘ä»¬æ‰€æœ‰æ¨¡å—çš„å‚è€ƒå®ç°ã€‚åœ¨é‡åˆ°ç–‘é—®æ—¶ï¼Œè¯·å‚è€ƒå…¶ä»£ç å’Œæµ‹è¯•çš„å†™æ³•ã€‚

2. æ ¸å¿ƒæ¶æ„ä¸å¼€å‘æµç¨‹

æœ¬é¡¹ç›®éµå¾ªä¸¥æ ¼çš„åˆ†å±‚æ¶æ„ï¼Œè¯·åœ¨å¼€å‘æ—¶ä¸¥æ ¼éµå®ˆï¼š

*   **API å±‚ (app/routers)**ï¼šè´Ÿè´£å¤„ç† HTTP è¯·æ±‚ï¼ŒéªŒè¯è¾“å…¥ï¼Œå¹¶è°ƒç”¨ä¸šåŠ¡é€»è¾‘å±‚ã€‚ä¸¥ç¦åŒ…å«ä¸šåŠ¡é€»è¾‘ã€‚
*   **ä¸šåŠ¡é€»è¾‘å±‚ (app/services)**ï¼šå®ç°æ ¸å¿ƒä¸šåŠ¡è§„åˆ™ï¼Œåè°ƒæ•°æ®è®¿é—®å±‚ã€‚**æ³¨æ„ï¼šService å±‚ä¸åº”ç›´æ¥ç®¡ç†æ•°æ®åº“äº‹åŠ¡ï¼ˆå¦‚è°ƒç”¨ conn.commit() æˆ– conn.rollback()ï¼‰ã€‚äº‹åŠ¡çš„å¼€å§‹ã€æäº¤å’Œå›æ»šåº”ç”±æä¾›æ•°æ®åº“è¿æ¥çš„ä¾èµ–æ³¨å…¥æœºåˆ¶æˆ–è°ƒç”¨ Service çš„æ›´é«˜å±‚ï¼ˆå¦‚ Router å±‚ç»“åˆä¾èµ–ï¼‰æ¥ç»Ÿä¸€å¤„ç†ã€‚Service å±‚åªè´Ÿè´£è°ƒç”¨ DAL å±‚çš„æ–¹æ³•ï¼Œå¹¶å¤„ç†ç”± DAL å±‚æˆ–ä¸šåŠ¡é€»è¾‘äº§ç”Ÿçš„å¼‚å¸¸ã€‚**
*   **æ•°æ®è®¿é—®å±‚ (app/dal)**ï¼šè´Ÿè´£ä¸æ•°æ®åº“äº¤äº’ï¼Œè°ƒç”¨å­˜å‚¨è¿‡ç¨‹ã€‚ä¸¥ç¦åŒ…å«ä¸šåŠ¡é€»è¾‘ã€‚
*   **æ•°æ®æ¨¡å‹å±‚ (app/schemas)**ï¼šå®šä¹‰ API çš„æ•°æ®å¥‘çº¦ (Pydantic æ¨¡å‹)ã€‚

**å¼€å‘äº”æ­¥æ³• (ä»¥"å•†å“æ¨¡å—"ä¸ºä¾‹)**:

1.  **æ•°æ®åº“å…ˆè¡Œ**ï¼šç¡®ä¿ products è¡¨ç›¸å…³çš„å­˜å‚¨è¿‡ç¨‹å·²ç»ç”±æ•°æ®åº“å›¢é˜Ÿå®ç°å¹¶æµ‹è¯•ã€‚
2.  **åˆ›å»º DAL**ï¼šåœ¨ `app/dal/products.py` ä¸­åˆ›å»º `ProductDAL`ï¼Œå°è£…å¯¹å•†å“ç›¸å…³å­˜å‚¨è¿‡ç¨‹çš„è°ƒç”¨ã€‚
3.  **åˆ›å»º Service**ï¼šåœ¨ `app/services/products.py` ä¸­åˆ›å»º `ProductService`ï¼Œå®ç°å•†å“ç®¡ç†çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚æ£€æŸ¥åº“å­˜ã€å¤„ç†å•†å“çŠ¶æ€ç­‰ï¼‰ã€‚
4.  **åˆ›å»º Router**ï¼šåœ¨ `app/routers/products.py` ä¸­åˆ›å»º API è·¯ç”±ï¼Œå¹¶ä½¿ç”¨ä¾èµ–æ³¨å…¥æ¥å¤„ç†è®¤è¯å’Œä¸šåŠ¡é€»è¾‘è°ƒç”¨ã€‚
5.  **ç¼–å†™æµ‹è¯•**ï¼šä¸ºä½ å†™çš„æ¯ä¸€å±‚ä»£ç ï¼ˆDAL, Service, Routerï¼‰ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ã€‚

3. å¦‚ä½•å¤„ç†ç”¨æˆ·è®¤è¯ï¼ˆå…³é”®ï¼ï¼‰

åœ¨å¼€å‘æ–°æ¨¡å—æ—¶ï¼Œå‡ ä¹æ‰€æœ‰APIéƒ½éœ€è¦éªŒè¯ç”¨æˆ·èº«ä»½ã€‚æˆ‘ä»¬å·²ç»å»ºç«‹äº†ä¸€å¥—æ ‡å‡†çš„ã€å¯é‡ç”¨çš„è®¤è¯ä¾èµ–ã€‚

*   **æ™®é€šç”¨æˆ·è®¤è¯**ï¼š`app.dependencies.get_current_user`
*   **ç®¡ç†å‘˜è®¤è¯**ï¼š`app.dependencies.get_current_active_admin_user`

ä½¿ç”¨æ–¹æ³•ï¼šåœ¨ä½ çš„è·¯ç”±å‡½æ•°ä¸­ï¼Œé€šè¿‡ `Depends()` æ³¨å…¥å®ƒä»¬ã€‚

ä»£ç ç¤ºä¾‹ï¼šåˆ›å»ºä¸€ä¸ªéœ€è¦ç™»å½•æ‰èƒ½å‘å¸ƒçš„æ–°å•†å“

```python
# app/routers/products.py
from fastapi import APIRouter, Depends, HTTPException, status
# å¯¼å…¥ä½ çš„ schema å’Œ service
from app.dependencies import get_current_user, get_db_connection # å‡è®¾ä½ éœ€è¦DBè¿æ¥
from app.schemas.product_schemas import ProductCreateSchema, ProductResponseSchema
from app.services.product_service import ProductService # å¯¼å…¥ Service ç±»ï¼Œç”¨äºç±»å‹æç¤ºå’Œä¾èµ–æ³¨å…¥

# ä» app.dependencies å¯¼å…¥ Service çš„ä¾èµ–å‡½æ•°
from app.dependencies import get_product_service # å‡è®¾ä½ å·²ç»å®šä¹‰äº† get_product_service ä¾èµ–å‡½æ•°

router = APIRouter(prefix="/products", tags=["Products"])

@router.post("/", response_model=ProductResponseSchema, status_code=status.HTTP_201_CREATED)
async def create_new_product(
    product_data: ProductCreateSchema, # è¯·æ±‚ä½“æ•°æ®ä¼šè‡ªåŠ¨é€šè¿‡ Pydantic éªŒè¯
    # ğŸ‘‡ å°±åƒè¿™æ ·ï¼Œæ³¨å…¥è®¤è¯ä¾èµ–ã€‚å¦‚æœTokenæ— æ•ˆæˆ–ç”¨æˆ·æ— æƒé™ï¼ŒFastAPIä¼šé€šè¿‡å¼‚å¸¸å¤„ç†å™¨è‡ªåŠ¨è¿”å› 401 æˆ– 403ã€‚
    current_user: dict = Depends(get_current_user),
    # æ³¨å…¥æ•°æ®åº“è¿æ¥å’Œ Serviceã€‚FastAPI ä¼šè‡ªåŠ¨å¤„ç†ä¾èµ–çš„å®ä¾‹åŒ–å’Œä¼ é€’ã€‚
    conn: pyodbc.Connection = Depends(get_db_connection), # æ˜ç¡®ç±»å‹ä¸º pyodbc.Connection
    product_service: ProductService = Depends(get_product_service) # æ³¨å…¥ Service å®ä¾‹
):
    """
    å‘å¸ƒä¸€ä¸ªæ–°å•†å“ï¼Œéœ€è¦ç”¨æˆ·ç™»å½•ã€‚
    """
    # ä»è®¤è¯ä¾èµ–è¿”å›çš„å­—å…¸ä¸­å®‰å…¨åœ°è·å–ç”¨æˆ·ID (UUID å¯¹è±¡)
    user_id = current_user.get("user_id")
    # åœ¨ä¾èµ–ä¸­å·²ç»å¤„ç†äº† None çš„æƒ…å†µï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†ç±»å‹å®‰å…¨å’Œæ˜ç¡®
    if not user_id:
        # ç†è®ºä¸Š get_current_user ä¼šæŠ›å‡º HTTPExceptionï¼Œä½†æ­¤å¤„ä½œä¸ºåŒé‡ä¿é™©
        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="æ— æ³•è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯")

    try:
        # è°ƒç”¨ä¸šåŠ¡é€»è¾‘å±‚ Service æ–¹æ³•ï¼Œä¼ å…¥æ•°æ®åº“è¿æ¥ã€è¯·æ±‚æ•°æ®å’Œç”¨æˆ·IDã€‚
        # Service å±‚è´Ÿè´£å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å’Œè°ƒç”¨ DALã€‚
        new_product = await product_service.create_product(conn, product_data, user_id) # Pass conn to service
        return new_product # Service åº”è¯¥è¿”å›ç¬¦åˆ ProductResponseSchema çš„æ•°æ®
    except IntegrityError as e:
        # æ•è· Service å±‚æŠ›å‡ºçš„ç‰¹å®šå¼‚å¸¸ï¼Œè½¬æ¢ä¸º HTTP å“åº”
        raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail=str(e))
    except ValueError as e:
         # æ•è· Service å±‚å› ä¸šåŠ¡è§„åˆ™ï¼ˆå¦‚æ•°æ®èŒƒå›´ï¼‰æŠ›å‡ºçš„ ValueError
         raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(e))
    except ForbiddenError as e:
         # æ•è· Service å±‚å› æƒé™é—®é¢˜æŠ›å‡ºçš„ ForbiddenError
         raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail=str(e))
    except NotFoundError as e:
         # æ•è· Service å±‚æ‰¾ä¸åˆ°èµ„æºçš„ NotFoundError
         raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=str(e))
    except DALError as e:
        # æ•è· Service å±‚å› æ•°æ®åº“æ“ä½œå¤±è´¥æŠ›å‡ºçš„ DALError
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=f"æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")
    except Exception as e:
        # æ•è·å…¶ä»–æœªé¢„æœŸé”™è¯¯
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=f"æœåŠ¡å™¨å†…éƒ¨é”™è¯¯: {e}")
```

4. å¦‚ä½•ç¼–å†™é«˜è´¨é‡çš„æµ‹è¯•ï¼ˆæ ¸å¿ƒè¦æ±‚ï¼ï¼‰

**ç¡¬æ€§è§„å®š**ï¼šæ²¡æœ‰æµ‹è¯•çš„åŠŸèƒ½ä»£ç ï¼Œä¸€å¾‹ä¸äºˆåˆå¹¶ (No Test, No Merge)ã€‚

ä½ é€šè¿‡ç”¨æˆ·æ¨¡å—æµ‹è¯•çš„ç»éªŒè‡³å…³é‡è¦ã€‚å…¶ä»–å¼€å‘è€…å¿…é¡»éµå¾ªç›¸åŒçš„æµ‹è¯•æ¨¡å¼ï¼Œä»¥é¿å…ä¹‹å‰é‡åˆ°çš„ 401 è®¤è¯é™·é˜±ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®© API é›†æˆæµ‹è¯•**ä¸ä¾èµ–çœŸå®æ•°æ®åº“å’ŒçœŸå®è®¤è¯**ã€‚

**API æµ‹è¯•çš„é»„é‡‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿè®¤è¯ä¾èµ–å’Œ Service å±‚**

æˆ‘ä»¬çš„æµ‹è¯•ç¯å¢ƒå·²ç»é…ç½®å¥½ï¼Œå¯ä»¥åœ¨æµ‹è¯•æ—¶ç»•è¿‡çœŸå®çš„TokenéªŒè¯ï¼Œç›´æ¥æ³¨å…¥ä¸€ä¸ª"å‡"ç”¨æˆ·ã€‚è¿™æ˜¯é€šè¿‡åœ¨ `tests/conftest.py` çš„ `client` fixture ä¸­ä½¿ç”¨ `app.dependency_overrides` æ¥**å…¨å±€è¦†ç›–è®¤è¯ä¾èµ–** (`get_current_user`, `get_current_active_admin_user`) å®ç°çš„ã€‚

åŒæ—¶ï¼Œä¸ºäº†éš”ç¦» API å±‚çš„æµ‹è¯•ï¼Œæˆ‘ä»¬è¿˜éœ€è¦**æ¨¡æ‹Ÿ Service å±‚**ã€‚é€šå¸¸åœ¨ `conftest.py` ä¸­å®šä¹‰ Service çš„ Mock fixtureï¼Œå¹¶åœ¨ `client` fixture ä¸­ä½¿ç”¨ `app.dependency_overrides` å°†çœŸå®çš„ Service ä¾èµ– (`get_user_service`) æ›¿æ¢ä¸º Mock å¯¹è±¡ã€‚

å¼€å‘è€…éœ€è¦åšçš„ï¼šåªéœ€åœ¨æµ‹è¯•å‡½æ•°ä¸­ç›´æ¥ä½¿ç”¨ `client` å’Œ `mock_your_service` (ä¾‹å¦‚ `mock_product_service`) è¿™äº› fixtureï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨å¤„ç†å¥½ä¾èµ–æ³¨å…¥å’Œ Mockã€‚

ä»£ç ç¤ºä¾‹ï¼šæµ‹è¯•"å‘å¸ƒæ–°å•†å“"çš„API

```python
# tests/product/test_products_api.py
import pytest
from fastapi.testclient import TestClient
from unittest.mock import AsyncMock # å¯¼å…¥ AsyncMock ç”¨äºæ¨¡æ‹Ÿå¼‚æ­¥å‡½æ•°
from uuid import uuid4 # å¯¼å…¥ uuid4 ç”Ÿæˆ UUID
from datetime import datetime, timezone # å¯¼å…¥ datetime å’Œ timezone å¤„ç†æ—¶é—´

# Import schemas and dependencies used in the router and test
from app.schemas.product_schemas import ProductCreateSchema, ProductResponseSchema # å¯¼å…¥å•†å“ç›¸å…³çš„ Schema
from app.dependencies import get_current_user # å¯¼å…¥å®é™…çš„è®¤è¯ä¾èµ–ï¼Œç”¨äºç±»å‹æç¤ºæˆ–å¶å°”çš„ä¸´æ—¶ override
from app.services.product_service import UserService # å¯¼å…¥ Service ç±»ï¼Œç”¨äº Mock çš„ spec
# å¯¼å…¥å¼‚å¸¸ç±»ï¼Œç”¨äºæ–­è¨€ Service æŠ›å‡ºçš„ç‰¹å®šå¼‚å¸¸è¢« Router æ­£ç¡®å¤„ç†
from app.exceptions import IntegrityError, ValueError, ForbiddenError, NotFoundError # Import exceptions
import pytest_mock # Import pytest_mock for mocker type hint
import pyodbc # Import pyodbc for conn type hint

# å‡è®¾è¿™æ˜¯ä½ ä¸º product_service å‡†å¤‡çš„ mock fixture å®šä¹‰ (é€šå¸¸æ”¾åœ¨ conftest.py)
# @pytest.fixture
# def mock_product_service(mocker: pytest_mock.MockerFixture) -> AsyncMock:
#     """Mock the ProductService dependency."""
#     # Create an AsyncMock instance for the ProductService class
#     mock_service = AsyncMock(spec=UserService) # Use the correct Service spec
#     # Patch the get_product_service dependency in app.dependencies or app.routers
#     # Or better yet, handle this override in the client fixture in conftest.py
#     # mocker.patch('app.dependencies.get_product_service', return_value=mock_service)
#     return mock_service


def test_create_product_success(client: TestClient, mock_product_service: AsyncMock, mocker: pytest_mock.MockerFixture): # æ³¨å…¥ client å’Œ mock_product_service fixture
    """
    æµ‹è¯•æˆåŠŸåˆ›å»ºä¸€ä¸ªå•†å“ã€‚
    'client' fixture ä¼šè‡ªåŠ¨å¤„ç†è®¤è¯ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªæ™®é€šç”¨æˆ·å·²ç™»å½•ã€‚
    'mock_product_service' fixture æä¾›äº† Service å±‚çš„ Mockã€‚
    """
    # 1. å‡†å¤‡æµ‹è¯•æ•°æ® (ä½¿ç”¨ Pydantic æ¨¡å‹)
    product_data = ProductCreateSchema(name="ä¹æˆæ–°è‡ªè¡Œè½¦", price=150.0, description="ä»£æ­¥ç¥å™¨")
    
    # ä» client fixture è·å–æ¨¡æ‹Ÿç”¨æˆ·çš„IDã€‚è¿™ä¸ªIDæ¥è‡ª conftest.py ä¸­é…ç½®çš„ mock è®¤è¯ä¾èµ–ã€‚
    mock_owner_id = client.test_user_id # å‡è®¾ client fixture é™„åŠ äº†è¿™ä¸ªå±æ€§ (è¿™æ˜¯ä¸€ä¸ª UUID å¯¹è±¡)

    # 2. é…ç½® Mock ä¸šåŠ¡é€»è¾‘å±‚çš„è¿”å›å€¼
    # ç¡®ä¿è¿”å›çš„æ•°æ®ç»“æ„ä¸ Service å±‚å®é™…è¿”å›çš„ä¸€è‡´ (Pydantic schema å®ä¾‹)
    # Service create_product method is expected to return a ProductResponseSchema instance
    # ä½¿ç”¨å›ºå®šæˆ–å¯é¢„æµ‹çš„å€¼ï¼Œä¾¿äºæ–­è¨€
    expected_created_product_schema = ProductResponseSchema(
        product_id=uuid4(), # Simulate a new UUID for the created product
        owner_id=mock_owner_id, # Owner ID should be the mocked user's ID
        name=product_data.name,
        price=product_data.price,
        description=product_data.description,
        # åŒ…å«æ‰€æœ‰å¿…å¡«å’Œå¯é€‰å­—æ®µï¼Œå³ä½¿æ˜¯ Noneï¼Œä»¥åŒ¹é… Schema ç»“æ„
        status="Available", # Example status
        created_at=datetime.now(timezone.utc), # Example timezone-aware datetime
        updated_at=datetime.now(timezone.utc), # Example timezone-aware datetime
        images=[], # åˆ—è¡¨ç±»å‹
        category="Other",
        location="Unknown",
        is_sold=False,
        buyer_id=None, # å¯é€‰å­—æ®µè®¾ä¸º None
        trade_id=None, # å¯é€‰å­—æ®µè®¾ä¸º None
        is_deleted=False,
    )
    # é…ç½® mock æ–¹æ³•çš„è¿”å›å€¼
    mock_product_service.create_product.return_value = expected_created_product_schema

    # 3. å‘èµ·APIè¯·æ±‚ (ä½¿ç”¨ TestClientï¼Œä¼ å…¥ json æ•°æ®)
    # TestClient ä¼šè‡ªåŠ¨å°†å­—å…¸åºåˆ—åŒ–ä¸º JSON
    # Use model_dump() å°† Pydantic æ¨¡å‹è½¬æ¢ä¸ºå­—å…¸ä½œä¸º JSON body
    response = client.post("/api/v1/products/", json=product_data.model_dump())

    # 4. æ–­è¨€ç»“æœ
    assert response.status_code == 201
    response_data = response.json() # TestClient å“åº”ä¼šè‡ªåŠ¨è§£æ JSON ä¸º Python å­—å…¸

    # æ¯”è¾ƒ API è¿”å›çš„ JSON æ•°æ®ï¼ˆå­—å…¸ï¼‰ä¸ Service Mock è¿”å›çš„ Schema ç»è¿‡ FastAPI åºåˆ—åŒ–åçš„é¢„æœŸç»“æœã€‚
    # ç›´æ¥æ¯”è¾ƒ JSON å­—å…¸ã€‚ FastAPI ä¼šå°† UUID å’Œ datetime å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚
    # æˆ‘ä»¬å¯ä»¥å°† Mock è¿”å›çš„ Schema ä¹Ÿè½¬æ¢ä¸º JSON å…¼å®¹çš„å­—å…¸è¿›è¡Œæ¯”è¾ƒã€‚
    expected_json_data = expected_created_product_schema.model_dump(mode='json', by_alias=True) # ä½¿ç”¨ mode='json' ç¡®ä¿ UUID å’Œ datetime è¢«åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²

    assert response_data == expected_json_data # ç›´æ¥æ¯”è¾ƒåºåˆ—åŒ–åçš„å­—å…¸

    # 5. éªŒè¯ Service Mock æ–¹æ³•æ˜¯å¦è¢«æ­£ç¡®è°ƒç”¨
    # Service create_product è¢«è°ƒç”¨æ—¶åº”ä¼ å…¥ conn, product_data (Pydantic æ¨¡å‹), å’Œ user_id (UUID å¯¹è±¡)
    # ä½¿ç”¨ mocker.ANY æ¥åŒ¹é…è¢«ä¾èµ–æ³¨å…¥çš„ conn å¯¹è±¡ (å®ƒå¯èƒ½æ˜¯ä¸€ä¸ª MagicMock)
    mock_product_service.create_product.assert_called_once_with(
        mocker.ANY, # åŒ¹é…æ³¨å…¥çš„æ•°æ®åº“è¿æ¥ (å¯èƒ½æ˜¯ MagicMock)
        product_data, # åŒ¹é…ä¼ å…¥çš„ Pydantic æ¨¡å‹å®ä¾‹
        mock_owner_id # åŒ¹é…ä¼ å…¥çš„ç”¨æˆ· ID (UUID å¯¹è±¡)
    )
    # æ³¨æ„ï¼šè®¤è¯ä¾èµ– (get_current_user) æ˜¯åœ¨ client fixture çº§åˆ«è¢« Mock çš„ï¼Œæ‰€ä»¥æ— éœ€åœ¨æ­¤æµ‹è¯•å‡½æ•°ä¸­å¯¹å®ƒè¿›è¡Œ assert_called_onceã€‚


def test_create_product_unauthorized(client: TestClient, mock_product_service: AsyncMock, mocker: pytest_mock.MockerFixture): # æ³¨å…¥ client å’Œ mock_product_service
    """
    æµ‹è¯•æœªç™»å½•ç”¨æˆ·ï¼ˆæˆ–æ— æ•ˆTokenï¼‰æ— æ³•åˆ›å»ºå•†å“ã€‚
    æˆ‘ä»¬é€šè¿‡ä¸´æ—¶è¦†ç›–è®¤è¯ä¾èµ–æ¥æ¨¡æ‹Ÿ unauthorized åœºæ™¯ã€‚
    """
    # 1. Prepare test data (using Pydantic model)
    product_data = ProductCreateSchema(name="æ— æƒé™å•†å“", price=10.0, description="åº”è¢«æ‹’ç»")

    # 2. ä¸´æ—¶è¦†ç›– get_current_user ä¾èµ–ï¼Œä½¿å…¶æŠ›å‡º 401 HTTPException
    # è¿™ä¼šè¦†ç›– client fixture ä¸­è®¾ç½®çš„é»˜è®¤æ¨¡æ‹Ÿè®¤è¯ä¾èµ–ï¼Œä»…åœ¨æ­¤æµ‹è¯•å‡½æ•°ä½œç”¨åŸŸå†…ç”Ÿæ•ˆã€‚
    original_override = client.app.dependency_overrides.get(get_current_user) # ä¿å­˜åŸå§‹è¦†ç›–ä»¥ä¾¿æ¢å¤
    
    # å®šä¹‰ä¸€ä¸ªæ¨¡æ‹Ÿå‡½æ•°ï¼ŒæŠ›å‡ºé¢„æœŸçš„ HTTPException
    async def mock_get_current_user_unauthorized_override():
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="æ— æ³•éªŒè¯çš„å‡­æ®", # ä½¿ç”¨å®é™…ä¾èµ–å¯èƒ½æŠ›å‡ºçš„ detail
            headers={"WWW-Authenticate": "Bearer"} # åŒ…å«å®é™…ä¾èµ–å¯èƒ½è¿”å›çš„ header
        )

    # åº”ç”¨ä¸´æ—¶è¦†ç›–
    client.app.dependency_overrides[get_current_user] = mock_get_current_user_unauthorized_override

    try:
        # 3. å‘èµ·APIè¯·æ±‚ (æ— éœ€æä¾› Authorization å¤´ï¼Œå› ä¸ºæˆ‘ä»¬æ¨¡æ‹Ÿäº†ä¾èµ–çš„è¡Œä¸º)
        # Use model_dump() å°† Pydantic æ¨¡å‹è½¬æ¢ä¸ºå­—å…¸ä½œä¸º JSON body
        response = client.post("/api/v1/products/", json=product_data.model_dump())
        
        # 4. æ–­è¨€ç»“æœ
        # å› ä¸ºè®¤è¯ä¾èµ–è¢«ä¸´æ—¶è¦†ç›–å¹¶æŠ›å‡ºäº† HTTPExceptionï¼Œæ‰€ä»¥ API ä¼šè¿”å›ç›¸åº”çš„é”™è¯¯å“åº”
        assert response.status_code == status.HTTP_401_UNAUTHORIZED # æœŸæœ›å¾—åˆ° 401 çŠ¶æ€ç 
        assert response.json().get('detail') == "æ— æ³•éªŒè¯çš„å‡­æ®" # éªŒè¯é”™è¯¯è¯¦æƒ…
        assert "WWW-Authenticate" in response.headers # éªŒè¯å¤´éƒ¨ä¿¡æ¯

        # åœ¨è¿™ç§è®¤è¯å¤±è´¥çš„æƒ…å†µä¸‹ï¼ŒService å±‚ä¸åº”è¯¥è¢«è°ƒç”¨
        mock_product_service.create_product.assert_not_called()

    finally:
        # 5. æµ‹è¯•å®Œæˆåï¼Œæ¸…ç†ä¸´æ—¶è¦†ç›–ï¼Œæ¢å¤åŸå§‹ä¾èµ–è®¾ç½®
        if original_override is not None:
            client.app.dependency_overrides[get_current_user] = original_override
        else:
            # å¦‚æœåŸå§‹æ²¡æœ‰è¦†ç›–ï¼Œå°±ç›´æ¥åˆ é™¤è¿™ä¸ª key
            del client.app.dependency_overrides[get_current_user]

5. å¼€å‘æ£€æŸ¥æ¸…å• (Checklist)

åœ¨å®Œæˆä¸€ä¸ªæ¨¡å—çš„å¼€å‘åï¼Œè¯·å¯¹ç…§ä»¥ä¸‹æ¸…å•è¿›è¡Œæ£€æŸ¥ï¼š

*   [ ] SQL è„šæœ¬ï¼š
    *   [ ] æ˜¯å¦å·²ä¸ºæ–°åŠŸèƒ½ç¼–å†™æˆ–ä¿®æ”¹äº†å­˜å‚¨è¿‡ç¨‹ã€è¡¨ç»“æ„ç­‰ï¼Ÿ
    *   [ ] æ˜¯å¦å·²æ›´æ–° `sql_scripts/drop_all.sql` ä»¥ä¾¿æ¸…ç©ºç›¸å…³å¯¹è±¡ï¼Ÿ
    *   [ ] æ˜¯å¦å·²æ›´æ–° `sql_scripts/db_init.py` ä»¥ä¾¿åŠ è½½å’Œæ‰§è¡Œæ–°çš„ SQL è„šæœ¬æ–‡ä»¶ï¼Ÿ
*   [ ] DAL å±‚ï¼š
    *   [ ] æ˜¯å¦å·²åˆ›å»º DAL ç±» (`app/dal/your_module_dal.py`) å¹¶æ³¨å…¥äº† `execute_query_func`ï¼Ÿ
    *   [ ] æ˜¯å¦ä¸ºæ‰€æœ‰ DAL æ–¹æ³•ç¼–å†™äº†å•å…ƒæµ‹è¯• (`tests/your_module/test_your_dal.py`)ï¼Œä½¿ç”¨ Mocking æ¨¡æ‹Ÿ `execute_query_func`ï¼Ÿ
*   [ ] Service å±‚ï¼š
    *   [ ] æ˜¯å¦å·²åˆ›å»º Service ç±» (`app/services/your_module_service.py`) å¹¶æ³¨å…¥äº† DAL å®ä¾‹ï¼Ÿ
    *   [ ] æ˜¯å¦ä¸ºæ‰€æœ‰ Service æ–¹æ³•ç¼–å†™äº†å•å…ƒæµ‹è¯• (`tests/your_module/test_your_service.py`)ï¼Œä½¿ç”¨ Mocking æ¨¡æ‹Ÿ DAL å’Œå…¶ä»–ä¾èµ–ï¼Ÿ
*   [ ] API å±‚ (Router)ï¼š
    *   [ ] æ˜¯å¦å·²åˆ›å»º API è·¯ç”±æ–‡ä»¶ (`app/routers/your_module_routes.py`)ï¼Ÿ
    *   [ ] æ˜¯å¦å®šä¹‰äº†ç¬¦åˆé¢„æœŸçš„ Pydantic Schemas (`app/schemas/your_module_schemas.py`)ï¼Ÿ
    *   [ ] æ˜¯å¦å¯¹éœ€è¦ä¿æŠ¤çš„è·¯ç”±æ­£ç¡®ä½¿ç”¨äº† `Depends(get_current_user)` æˆ– `Depends(get_current_active_admin_user)`ï¼Ÿ
    *   [ ] æ˜¯å¦åœ¨è·¯ç”±å™¨å±‚æ•è· Service æŠ›å‡ºçš„ç‰¹å®šä¸šåŠ¡å¼‚å¸¸ (å¦‚ NotFoundError, IntegrityError, ValueError ç­‰) å¹¶è½¬æ¢ä¸ºé€‚å½“çš„ HTTP å“åº”ï¼Ÿ
    *   [ ] æ˜¯å¦å·²ä¸ºä¸»åº”ç”¨æ–‡ä»¶ `app/main.py` æ·»åŠ äº†æ–°è·¯ç”±æ¨¡å—ï¼Ÿ
*   [ ] API é›†æˆæµ‹è¯•ï¼š
    *   [ ] æ˜¯å¦ä¸ºæ‰€æœ‰ API è·¯ç”±ç¼–å†™äº†é›†æˆæµ‹è¯• (`tests/your_module/test_your_api.py`)ï¼Œä½¿ç”¨ `TestClient`ï¼Œå¹¶ Mock äº† Service å±‚å’Œè®¤è¯ä¾èµ–ï¼Ÿ
    *   [ ] æ˜¯å¦é‡ç‚¹æµ‹è¯•äº†è®¤è¯æˆåŠŸã€è®¤è¯å¤±è´¥ã€æƒé™ä¸è¶³ç­‰åœºæ™¯ï¼Ÿ
    *   [ ] æ˜¯å¦æµ‹è¯•äº†è¾“å…¥éªŒè¯ (Pydantic 422 é”™è¯¯) å’Œ Service å±‚æŠ›å‡ºçš„ä¸šåŠ¡å¼‚å¸¸ï¼ˆå¦‚ 400, 404, 409 ç­‰ï¼‰ï¼Ÿ
*   [ ] ä¾èµ–æ³¨å…¥ï¼šæ˜¯å¦å·²åœ¨ `app/dependencies.py` ä¸­ä¸ºæ–°çš„ Service åˆ›å»ºäº†ä¾èµ–æ³¨å…¥å‡½æ•°ï¼Ÿ
*   [ ] æ–‡æ¡£ï¼šæ˜¯å¦å·²æ›´æ–° `README.md`ã€`TODO.md` åŠç›¸å…³æ–‡æ¡£ï¼Œè¯´æ˜æ–°æ¨¡å—çš„åŠŸèƒ½å’Œå¼€å‘çŠ¶æ€ï¼Ÿ
*   [ ] Git å·¥ä½œæµï¼šæäº¤ä»£ç æ—¶æ˜¯å¦å¼•ç”¨äº†ç›¸å…³çš„ TODO é¡¹ï¼Ÿ

6. å…¶ä»–æ³¨æ„äº‹é¡¹

*   **æ—¥å¿—è®°å½•:** åœ¨å…³é”®ä¸šåŠ¡é€»è¾‘å’Œå¼‚å¸¸å¤„ç†å¤„æ·»åŠ æ—¥å¿—è®°å½•ã€‚
*   **å¼‚æ­¥ç¼–ç¨‹:** ç¡®ä¿ä½ çš„ DAL å’Œ Service æ–¹æ³•æ˜¯å¼‚æ­¥çš„ (`async def`)ï¼Œå¹¶ä½¿ç”¨ `await` è°ƒç”¨å¼‚æ­¥æ“ä½œã€‚
*   **é…ç½®ç®¡ç†:** ä½¿ç”¨ `app.config.settings` æ¥è®¿é—®é…ç½®ä¿¡æ¯ã€‚
*   **å¼‚å¸¸å¤„ç†:** é™¤äº† Service å±‚æŠ›å‡ºçš„ç‰¹å®šä¸šåŠ¡å¼‚å¸¸å¤–ï¼Œç¡®ä¿è·¯ç”±å™¨å±‚æœ‰å…œåº•çš„å¼‚å¸¸å¤„ç†ï¼Œä»¥æ•è·å…¶ä»–æœªé¢„æœŸé”™è¯¯å¹¶è¿”å› 500 çŠ¶æ€ç ã€‚
*   **ä»£ç è¯„å®¡:** åœ¨æäº¤åˆå¹¶è¯·æ±‚å‰ï¼Œè¯·ç¡®ä¿ä»£ç ç»è¿‡ä»”ç»†æ£€æŸ¥ï¼Œå¹¶ç¬¦åˆé¡¹ç›®è§„èŒƒã€‚

---

ç¥æ‚¨å¼€å‘é¡ºåˆ©ï¼ 